<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Web Extensions</title>
  <meta content="CG-DRAFT" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version 3f621ba99, updated Mon Jul 28 15:38:36 2025 -0700" name="generator">
  <link href="https://w3c.github.io/webextensions/specification/index.html" rel="canonical">
  <meta content="e8d17bc0f56f5326b111a710a774fa03aa206846" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/">
    <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72">
</a>
</p>
   <h1 class="p-name no-ref" id="title">Web Extensions</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#CG-DRAFT">Draft Community Group Report</a>,
    <time class="dt-updated" datetime="2025-10-13">13 October 2025</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/webextensions/specification/index.html">https://w3c.github.io/webextensions/specification/index.html</a>
      <dt>Issue Tracking:
      <dd><a href="https://github.com/w3c/webextensions/issues/">GitHub</a>
      <dd><a href="#issues-index">Inline In Spec</a>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:mpurohit@microsoft.com">Mukul Purohit</a> (<a class="p-org org" href="https://www.microsoft.com">Microsoft Corporation</a>)
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:tjovanovic@mozilla.com">Tomislav Jovanovic</a> (<a class="p-org org" href="https://www.mozilla.org/">Mozilla</a>)
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:oliverdunk@chromium.org">Oliver Dunk</a> (<a class="p-org org" href="https://www.google.com">Google</a>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 the Contributors to the Web Extensions Specification, published by the <a href="https://www.w3.org/community/webextensions/">WebExtensions Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.
</p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>[Placeholder] Abstract.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p>
  This specification was published by the <a href="https://www.w3.org/community/webextensions/">WebExtensions Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the
  <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>
  there is a limited opt-out and other conditions apply.

  Learn more about
  <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>.
</p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#file-structure"><span class="secno">1</span> <span class="content">File structure</span></a>
     <ol class="toc">
      <li><a href="#manifestjson"><span class="secno">1.1</span> <span class="content">manifest.json</span></a>
      <li><a href="#_locales-subdirectory"><span class="secno">1.2</span> <span class="content">_locales subdirectory</span></a>
      <li><a href="#other-files"><span class="secno">1.3</span> <span class="content">Other files</span></a>
     </ol>
    <li>
     <a href="#manifest"><span class="secno">2</span> <span class="content">Manifest</span></a>
     <ol class="toc">
      <li><a href="#manifest-file"><span class="secno">2.1</span> <span class="content">Manifest file</span></a>
      <li>
       <a href="#manifest-keys"><span class="secno">2.2</span> <span class="content">Manifest keys</span></a>
       <ol class="toc">
        <li><a href="#key-manifest_version"><span class="secno">2.2.1</span> <span class="content">Key <code>manifest_version</code></span></a>
        <li><a href="#key-name"><span class="secno">2.2.2</span> <span class="content">Key <code>name</code></span></a>
        <li><a href="#key-version"><span class="secno">2.2.3</span> <span class="content">Key <code>version</code></span></a>
        <li><a href="#key-permissions"><span class="secno">2.2.4</span> <span class="content">Key <code>permissions</code></span></a>
        <li><a href="#key-optional_permissions"><span class="secno">2.2.5</span> <span class="content">Key <code>optional_permissions</code></span></a>
        <li><a href="#key-host_permissions"><span class="secno">2.2.6</span> <span class="content">Key <code>host_permissions</code></span></a>
        <li><a href="#key-optional_host_permissions"><span class="secno">2.2.7</span> <span class="content">Key <code>optional_host_permissions</code></span></a>
        <li><a href="#key-default_locale"><span class="secno">2.2.8</span> <span class="content">Key <code>default_locale</code></span></a>
        <li><a href="#key-background"><span class="secno">2.2.9</span> <span class="content">Key <code>background</code></span></a>
        <li><a href="#key-commands"><span class="secno">2.2.10</span> <span class="content">Key <code>commands</code></span></a>
        <li><a href="#key-content_scripts"><span class="secno">2.2.11</span> <span class="content">Key <code>content_scripts</code></span></a>
        <li><a href="#key-content_security_policy"><span class="secno">2.2.12</span> <span class="content">Key <code>content_security_policy</code></span></a>
        <li><a href="#key-description"><span class="secno">2.2.13</span> <span class="content">Key <code>description</code></span></a>
        <li><a href="#key-icons"><span class="secno">2.2.14</span> <span class="content">Key <code>icons</code></span></a>
        <li><a href="#key-options_ui"><span class="secno">2.2.15</span> <span class="content">Key <code>options_ui</code></span></a>
        <li><a href="#key-short_name"><span class="secno">2.2.16</span> <span class="content">Key <code>short_name</code></span></a>
        <li><a href="#key-web_accessible_resources"><span class="secno">2.2.17</span> <span class="content">Key <code>web_accessible_resources</code></span></a>
        <li><a href="#key-externally_connectable"><span class="secno">2.2.18</span> <span class="content">Key <code>externally_connectable</code></span></a>
        <li><a href="#key-devtools_page"><span class="secno">2.2.19</span> <span class="content">Key <code>devtools_page</code></span></a>
       </ol>
      <li><a href="#reserved-file-names"><span class="secno">2.3</span> <span class="content">Reserved file names</span></a>
     </ol>
    <li><a href="#isolated-worlds"><span class="secno">3</span> <span class="content">Isolated worlds</span></a>
    <li><a href="#unavailable-apis"><span class="secno">4</span> <span class="content">Unavailable APIs</span></a>
    <li><a href="#the-browser-global"><span class="secno">5</span> <span class="content">The <code>browser</code> global</span></a>
    <li><a href="#extension-origin"><span class="secno">6</span> <span class="content">Extension origin</span></a>
    <li><a href="#localization"><span class="secno">7</span> <span class="content">Localization</span></a>
    <li>
     <a href="#host-permissions"><span class="secno">8</span> <span class="content">Host permissions</span></a>
     <ol class="toc">
      <li><a href="#cross-origin-fetch"><span class="secno">8.1</span> <span class="content">Cross-origin fetch</span></a>
     </ol>
    <li><a href="#match-patterns"><span class="secno">9</span> <span class="content">Match patterns</span></a>
    <li><a href="#globs"><span class="secno">10</span> <span class="content">Globs</span></a>
    <li>
     <a href="#concepts"><span class="secno">11</span> <span class="content">Concepts</span></a>
     <ol class="toc">
      <li><a href="#uniqueness-of-extension-ids"><span class="secno">11.1</span> <span class="content">Uniqueness of extension IDs</span></a>
      <li><a href="#promises-and-callbacks"><span class="secno">11.2</span> <span class="content">Promises and callbacks</span></a>
      <li><a href="#user-gestures-and-activetab"><span class="secno">11.3</span> <span class="content">User gestures and activeTab</span></a>
      <li><a href="#extension-permissions-and-web-perissions"><span class="secno">11.4</span> <span class="content">Extension permissions and web perissions</span></a>
     </ol>
    <li><a href="#content-security-policy"><span class="secno">12</span> <span class="content">Content security policy</span></a>
    <li>
     <a href="#architecture"><span class="secno">13</span> <span class="content">Architecture</span></a>
     <ol class="toc">
      <li><a href="#background-content"><span class="secno">13.1</span> <span class="content">Background content</span></a>
      <li>
       <a href="#content-scripts"><span class="secno">13.2</span> <span class="content">Content scripts</span></a>
       <ol class="toc">
        <li><a href="#key-matches"><span class="secno">13.2.1</span> <span class="content">Key <code>matches</code></span></a>
        <li><a href="#key-exclude_matches"><span class="secno">13.2.2</span> <span class="content">Key <code>exclude_matches</code></span></a>
        <li><a href="#key-js"><span class="secno">13.2.3</span> <span class="content">Key <code>js</code></span></a>
        <li><a href="#key-css"><span class="secno">13.2.4</span> <span class="content">Key <code>css</code></span></a>
        <li><a href="#key-all_frames"><span class="secno">13.2.5</span> <span class="content">Key <code>all_frames</code></span></a>
        <li><a href="#key-match_about_blank"><span class="secno">13.2.6</span> <span class="content">Key <code>match_about_blank</code></span></a>
        <li><a href="#key-match_origin_as_fallback"><span class="secno">13.2.7</span> <span class="content">Key <code>match_origin_as_fallback</code></span></a>
        <li><a href="#key-run_at"><span class="secno">13.2.8</span> <span class="content">Key <code>run_at</code></span></a>
        <li><a href="#key-include_globs"><span class="secno">13.2.9</span> <span class="content">Key <code>include_globs</code></span></a>
        <li><a href="#key-exclude_globs"><span class="secno">13.2.10</span> <span class="content">Key <code>exclude_globs</code></span></a>
        <li><a href="#key-world"><span class="secno">13.2.11</span> <span class="content">Key <code>world</code></span></a>
        <li><a href="#runat-enum"><span class="secno">13.2.12</span> <span class="content"><span>RunAt</span> enum</span></a>
        <li><a href="#executionworld-enum"><span class="secno">13.2.13</span> <span class="content"><span>ExecutionWorld</span> enum</span></a>
       </ol>
      <li><a href="#extension-pages"><span class="secno">13.3</span> <span class="content">Extension pages</span></a>
     </ol>
    <li><a href="#classes-of-security-risk"><span class="secno">14</span> <span class="content">Classes of security risk</span></a>
    <li><a href="#web-accessible-resources"><span class="secno">15</span> <span class="content">Web accessible resources</span></a>
    <li>
     <a href="#interaction-with-the-web"><span class="secno">16</span> <span class="content">Interaction with the web</span></a>
     <ol class="toc">
      <li><a href="#current-behavior-of-cookie-partitioning"><span class="secno">16.1</span> <span class="content">Current behavior of cookie partitioning</span></a>
     </ol>
    <li><a href="#version-number-handling"><span class="secno">17</span> <span class="content">Version number handling</span></a>
    <li>
     <a href="#algorithms"><span class="secno">18</span> <span class="content">Algorithms</span></a>
     <ol class="toc">
      <li><a href="#determine-the-url-for-matching-a-document"><span class="secno">18.1</span> <span class="content">Determine the URL for matching a document</span></a>
      <li><a href="#inject-a-content-script"><span class="secno">18.2</span> <span class="content">Inject a content script</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="file-structure"><span class="secno">1. </span><span class="content">File structure</span><a class="self-link" href="#file-structure"></a></h2>
   <p>Once unpacked from the distribution format, a WebExtension is a directory containing a number of files.</p>
   <p class="note" role="note"><span class="marker">Note:</span> In some operating systems, filenames are case insensitive. This can lead to naming collisions.</p>
   <h3 class="heading settled" data-level="1.1" id="manifestjson"><span class="secno">1.1. </span><span class="content">manifest.json</span><a class="self-link" href="#manifestjson"></a></h3>
   <p>A <a href="#manifest">Manifest</a> file.</p>
   <h3 class="heading settled" data-level="1.2" id="_locales-subdirectory"><span class="secno">1.2. </span><span class="content">_locales subdirectory</span><a class="self-link" href="#_locales-subdirectory"></a></h3>
   <p>An optional directory containing strings as defined in <a href="#localization">localization</a>.</p>
   <h3 class="heading settled" data-level="1.3" id="other-files"><span class="secno">1.3. </span><span class="content">Other files</span><a class="self-link" href="#other-files"></a></h3>
   <p>An extension may also contain other files, such as those referenced in the <a href="#key-content_scripts">§ 2.2.11 Key content_scripts</a> and <a href="#key-background">§ 2.2.9 Key background</a> parts of the <a data-link-type="dfn" href="#manifest①" id="ref-for-manifest①">manifest</a>.</p>
   <h2 class="heading settled" data-level="2" id="manifest"><span class="secno">2. </span><span class="content">Manifest</span><a class="self-link" href="#manifest"></a></h2>
   <p>A WebExtension must have a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="manifest①">manifest</dfn> file at its root directory.</p>
   <h3 class="heading settled" data-level="2.1" id="manifest-file"><span class="secno">2.1. </span><span class="content">Manifest file</span><a class="self-link" href="#manifest-file"></a></h3>
   <p>A manifest file is a <a data-link-type="biblio" href="#biblio-json" title="The JavaScript Object Notation (JSON) Data Interchange Format">[JSON]</a> document named <code>manifest.json</code>. Malformed JSON files are not supported. Note that some implementors may accept comments, represented by any content following <code>//</code> outside of a JSON string.</p>
   <h3 class="heading settled" data-level="2.2" id="manifest-keys"><span class="secno">2.2. </span><span class="content">Manifest keys</span><a class="self-link" href="#manifest-keys"></a></h3>
   <p>If manifest keys that are not defined in this specification are specified, implementors must ignore those keys.</p>
   <p>If manifest keys that are defined in this specification are specified with a different JSON type than defined in this specification, implementors must ignore those keys.</p>
   <p>The following keys must be considered valid:</p>
   <ul>
    <li data-md>
     <p><a href="#key-manifest_version"><code>manifest_version</code></a>: required.</p>
    <li data-md>
     <p><a href="#key-name"><code>name</code></a>: required.</p>
    <li data-md>
     <p><a href="#key-version"><code>version</code></a>: required.</p>
    <li data-md>
     <p><a href="#key-default_locale"><code>default_locale</code></a>: required under some conditions.</p>
    <li data-md>
     <p><a href="#key-background"><code>background</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-commands"><code>commands</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-content_scripts"><code>content_scripts</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-content_security_policy"><code>content_security_policy</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-description"><code>description</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-icons"><code>icons</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-optional_permissions"><code>optional_permissions</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-options_ui"><code>options_ui</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-permissions"><code>permissions</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-short_name"><code>short_name</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-web_accessible_resources"><code>web_accessible_resources</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-devtools_page"><code>devtools_page</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-externally_connectable"><code>externally_connectable</code></a>: optional</p>
   </ul>
   <p>The following keys must be considered valid in Manifest V3:</p>
   <ul>
    <li data-md>
     <p><a href="#key-host_permissions"><code>host_permissions</code></a>: optional</p>
    <li data-md>
     <p><a href="#key-optional_host_permissions"><code>optional_host_permissions</code></a>: optional</p>
   </ul>
   <h4 class="heading settled" data-level="2.2.1" id="key-manifest_version"><span class="secno">2.2.1. </span><span class="content">Key <code>manifest_version</code></span><a class="self-link" href="#key-manifest_version"></a></h4>
   <p>This key must be present.</p>
   <h4 class="heading settled" data-level="2.2.2" id="key-name"><span class="secno">2.2.2. </span><span class="content">Key <code>name</code></span><a class="self-link" href="#key-name"></a></h4>
   <p>Name of the extension used in the browser’s user interface. This should be the full name used to identify the extension. See also <a href="#key-short_name"><code>short_name</code></a>.</p>
   <p>This key must be present. This property can be localized.</p>
   <h4 class="heading settled" data-level="2.2.3" id="key-version"><span class="secno">2.2.3. </span><span class="content">Key <code>version</code></span><a class="self-link" href="#key-version"></a></h4>
   <p>This key must be present.</p>
   <h4 class="heading settled" data-level="2.2.4" id="key-permissions"><span class="secno">2.2.4. </span><span class="content">Key <code>permissions</code></span><a class="self-link" href="#key-permissions"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.5" id="key-optional_permissions"><span class="secno">2.2.5. </span><span class="content">Key <code>optional_permissions</code></span><a class="self-link" href="#key-optional_permissions"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.6" id="key-host_permissions"><span class="secno">2.2.6. </span><span class="content">Key <code>host_permissions</code></span><a class="self-link" href="#key-host_permissions"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.7" id="key-optional_host_permissions"><span class="secno">2.2.7. </span><span class="content">Key <code>optional_host_permissions</code></span><a class="self-link" href="#key-optional_host_permissions"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.8" id="key-default_locale"><span class="secno">2.2.8. </span><span class="content">Key <code>default_locale</code></span><a class="self-link" href="#key-default_locale"></a></h4>
   <p>This key must be present if the <code>_locales</code> subdirectory is present, must be absent otherwise.</p>
   <h4 class="heading settled" data-level="2.2.9" id="key-background"><span class="secno">2.2.9. </span><span class="content">Key <code>background</code></span><a class="self-link" href="#key-background"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.10" id="key-commands"><span class="secno">2.2.10. </span><span class="content">Key <code>commands</code></span><a class="self-link" href="#key-commands"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.11" id="key-content_scripts"><span class="secno">2.2.11. </span><span class="content">Key <code>content_scripts</code></span><a class="self-link" href="#key-content_scripts"></a></h4>
   <p>The <a href="#key-content_scripts"><code>content_scripts</code></a> key is a <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type">list</a> of items representing <a data-link-type="dfn" href="#content-scripts①" id="ref-for-content-scripts①">content scripts</a> that should be registered.</p>
   <h4 class="heading settled" data-level="2.2.12" id="key-content_security_policy"><span class="secno">2.2.12. </span><span class="content">Key <code>content_security_policy</code></span><a class="self-link" href="#key-content_security_policy"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.13" id="key-description"><span class="secno">2.2.13. </span><span class="content">Key <code>description</code></span><a class="self-link" href="#key-description"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.14" id="key-icons"><span class="secno">2.2.14. </span><span class="content">Key <code>icons</code></span><a class="self-link" href="#key-icons"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.15" id="key-options_ui"><span class="secno">2.2.15. </span><span class="content">Key <code>options_ui</code></span><a class="self-link" href="#key-options_ui"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.16" id="key-short_name"><span class="secno">2.2.16. </span><span class="content">Key <code>short_name</code></span><a class="self-link" href="#key-short_name"></a></h4>
   <p>The short name of the extension. This value should be used in contexts where <a href="#key-name"><code>name</code></a> is too long to use in full. If <code>short_name</code> is not provided, manifest consumers should use a truncated version of <code>name</code>.</p>
   <p>This key may be present. This property can be localized.</p>
   <h4 class="heading settled" data-level="2.2.17" id="key-web_accessible_resources"><span class="secno">2.2.17. </span><span class="content">Key <code>web_accessible_resources</code></span><a class="self-link" href="#key-web_accessible_resources"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.18" id="key-externally_connectable"><span class="secno">2.2.18. </span><span class="content">Key <code>externally_connectable</code></span><a class="self-link" href="#key-externally_connectable"></a></h4>
   <p>This key may be present.</p>
   <h4 class="heading settled" data-level="2.2.19" id="key-devtools_page"><span class="secno">2.2.19. </span><span class="content">Key <code>devtools_page</code></span><a class="self-link" href="#key-devtools_page"></a></h4>
   <p>This key may be present.</p>
   <h3 class="heading settled" data-level="2.3" id="reserved-file-names"><span class="secno">2.3. </span><span class="content">Reserved file names</span><a class="self-link" href="#reserved-file-names"></a></h3>
   <p>Filenames beginning with an underscore (<code>_</code>) are reserved for use by user agent.</p>
   <h2 class="heading settled" data-level="3" id="isolated-worlds"><span class="secno">3. </span><span class="content">Isolated worlds</span><a class="self-link" href="#isolated-worlds"></a></h2>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="worlds">Worlds</dfn> are isolated JavaScript contexts with access to the same underlying DOM tree but their own set of wrappers around those DOM objects. Declarations in the global scope are also isolated.</p>
   <h2 class="heading settled" data-level="4" id="unavailable-apis"><span class="secno">4. </span><span class="content">Unavailable APIs</span><a class="self-link" href="#unavailable-apis"></a></h2>
   <h2 class="heading settled" data-level="5" id="the-browser-global"><span class="secno">5. </span><span class="content">The <code>browser</code> global</span><a class="self-link" href="#the-browser-global"></a></h2>
   <h2 class="heading settled" data-level="6" id="extension-origin"><span class="secno">6. </span><span class="content">Extension origin</span><a class="self-link" href="#extension-origin"></a></h2>
   <h2 class="heading settled" data-level="7" id="localization"><span class="secno">7. </span><span class="content">Localization</span><a class="self-link" href="#localization"></a></h2>
   <p>The _locales subdirectory of a WebExtension can contain strings for internationalization purposes.</p>
   <p class="issue" id="issue-e5b8cfc7"><a class="self-link" href="#issue-e5b8cfc7"></a> Specify localization handling. <a href="https://github.com/w3c/webextensions/issues/62">[Issue #62]</a></p>
   <h2 class="heading settled" data-level="8" id="host-permissions"><span class="secno">8. </span><span class="content">Host permissions</span><a class="self-link" href="#host-permissions"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="cross-origin-fetch"><span class="secno">8.1. </span><span class="content">Cross-origin fetch</span><a class="self-link" href="#cross-origin-fetch"></a></h3>
   <h2 class="heading settled" data-level="9" id="match-patterns"><span class="secno">9. </span><span class="content">Match patterns</span><a class="self-link" href="#match-patterns"></a></h2>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="match-pattern">match pattern</dfn> is a pattern used to match URLs. They are case-insensitive.</p>
   <h2 class="heading settled" data-level="10" id="globs"><span class="secno">10. </span><span class="content">Globs</span><a class="self-link" href="#globs"></a></h2>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glob">glob</dfn> can be any <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a>. It can contain any number of wildcards where <code>*</code> can match zero or more characters and <code>?</code> matches exactly one character.</p>
   <h2 class="heading settled" data-level="11" id="concepts"><span class="secno">11. </span><span class="content">Concepts</span><a class="self-link" href="#concepts"></a></h2>
   <h3 class="heading settled" data-level="11.1" id="uniqueness-of-extension-ids"><span class="secno">11.1. </span><span class="content">Uniqueness of extension IDs</span><a class="self-link" href="#uniqueness-of-extension-ids"></a></h3>
   <h3 class="heading settled" data-level="11.2" id="promises-and-callbacks"><span class="secno">11.2. </span><span class="content">Promises and callbacks</span><a class="self-link" href="#promises-and-callbacks"></a></h3>
   <h3 class="heading settled" data-level="11.3" id="user-gestures-and-activetab"><span class="secno">11.3. </span><span class="content">User gestures and activeTab</span><a class="self-link" href="#user-gestures-and-activetab"></a></h3>
   <h3 class="heading settled" data-level="11.4" id="extension-permissions-and-web-perissions"><span class="secno">11.4. </span><span class="content">Extension permissions and web perissions</span><a class="self-link" href="#extension-permissions-and-web-perissions"></a></h3>
   <h2 class="heading settled" data-level="12" id="content-security-policy"><span class="secno">12. </span><span class="content">Content security policy</span><a class="self-link" href="#content-security-policy"></a></h2>
   <h2 class="heading settled" data-level="13" id="architecture"><span class="secno">13. </span><span class="content">Architecture</span><a class="self-link" href="#architecture"></a></h2>
   <h3 class="heading settled" data-level="13.1" id="background-content"><span class="secno">13.1. </span><span class="content">Background content</span><a class="self-link" href="#background-content"></a></h3>
   <h3 class="heading settled" data-level="13.2" id="content-scripts"><span class="secno">13.2. </span><span class="content">Content scripts</span><a class="self-link" href="#content-scripts"></a></h3>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="content-scripts①">Content scripts</dfn> represent a set of JS and CSS files that should be injected into matching pages loaded by the user agent. They are injected using the steps in <a href="#inject-a-content-script">§ 18.2 Inject a content script</a>.</p>
   <h4 class="heading settled" data-level="13.2.1" id="key-matches"><span class="secno">13.2.1. </span><span class="content">Key <code>matches</code></span><a class="self-link" href="#key-matches"></a></h4>
   <p>A <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type①">list</a> of <a data-link-type="dfn" href="#match-pattern" id="ref-for-match-pattern">match patterns</a> that are used to decide which pages the user agent injects the content script into. This key is required.</p>
   <h4 class="heading settled" data-level="13.2.2" id="key-exclude_matches"><span class="secno">13.2.2. </span><span class="content">Key <code>exclude_matches</code></span><a class="self-link" href="#key-exclude_matches"></a></h4>
   <p>A <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type②">list</a> of <a data-link-type="dfn" href="#match-pattern" id="ref-for-match-pattern①">match patterns</a> that can be used to specify URLs where the content script should not run, even if the URL matches entries in <a href="#key-matches">§ 13.2.1 Key matches</a> and (if specified) <a href="#key-include_globs">§ 13.2.9 Key include_globs</a>.</p>
   <h4 class="heading settled" data-level="13.2.3" id="key-js"><span class="secno">13.2.3. </span><span class="content">Key <code>js</code></span><a class="self-link" href="#key-js"></a></h4>
   <p>A <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type③">list</a> of file paths, relative to the extension’s package, that should be injected as scripts.</p>
   <h4 class="heading settled" data-level="13.2.4" id="key-css"><span class="secno">13.2.4. </span><span class="content">Key <code>css</code></span><a class="self-link" href="#key-css"></a></h4>
   <p>A <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type④">list</a> of file paths, relative to the extension’s package, that should be injected as stylesheets.</p>
   <h4 class="heading settled" data-level="13.2.5" id="key-all_frames"><span class="secno">13.2.5. </span><span class="content">Key <code>all_frames</code></span><a class="self-link" href="#key-all_frames"></a></h4>
   <p>If <code>all_frames</code> is <code>true</code>, the content script must be injected into any subframes that match the other matching criteria for the content script. If <code>false</code>, content scripts will only be injected into top-level documents. Defaults to <code>false</code>.</p>
   <h4 class="heading settled" data-level="13.2.6" id="key-match_about_blank"><span class="secno">13.2.6. </span><span class="content">Key <code>match_about_blank</code></span><a class="self-link" href="#key-match_about_blank"></a></h4>
   <p>If this is <code>true</code>, use the URL of the parent frame when matching a child frame whose document URL is <code>about:blank</code> or <code>about:srcdoc</code>. See also <a href="#determine-the-url-for-matching-a-document">§ 18.1 Determine the URL for matching a document</a>. Defaults to <code>false</code>.</p>
   <h4 class="heading settled" data-level="13.2.7" id="key-match_origin_as_fallback"><span class="secno">13.2.7. </span><span class="content">Key <code>match_origin_as_fallback</code></span><a class="self-link" href="#key-match_origin_as_fallback"></a></h4>
   <p>If this is <code>true</code>, use fallbacks as described in <a href="#determine-the-url-for-matching-a-document">§ 18.1 Determine the URL for matching a document</a>.</p>
   <p>No path is available when the URL to match against falls back to an origin. Therefore, when set, the user agent may treat a <a href="#key-matches">§ 13.2.1 Key matches</a> with a path other than <code>/*</code> as an error.</p>
   <p>Defaults to <code>false</code>.</p>
   <h4 class="heading settled" data-level="13.2.8" id="key-run_at"><span class="secno">13.2.8. </span><span class="content">Key <code>run_at</code></span><a class="self-link" href="#key-run_at"></a></h4>
   <p>Specifies when the content script should be injected. Valid values are defined by the <code class="idl"><a data-link-type="idl" href="#enumdef-runat" id="ref-for-enumdef-runat">RunAt</a></code> enum.</p>
   <h4 class="heading settled" data-level="13.2.9" id="key-include_globs"><span class="secno">13.2.9. </span><span class="content">Key <code>include_globs</code></span><a class="self-link" href="#key-include_globs"></a></h4>
   <p>A list of <a data-link-type="dfn" href="#glob" id="ref-for-glob">globs</a> that a document should match. A document matches if the URL matches both the <a href="#key-matches">§ 13.2.1 Key matches</a> field and the <a href="#key-include_globs">§ 13.2.9 Key include_globs</a> field.</p>
   <h4 class="heading settled" data-level="13.2.10" id="key-exclude_globs"><span class="secno">13.2.10. </span><span class="content">Key <code>exclude_globs</code></span><a class="self-link" href="#key-exclude_globs"></a></h4>
   <p>A <a data-link-type="dfn" href="https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type" id="ref-for-sec-list-and-record-specification-type⑤">list</a> of <a data-link-type="dfn" href="#glob" id="ref-for-glob①">globs</a> that can be used to specify URLs where the content script should not run, even if the URL matches entries in <a href="#key-matches">§ 13.2.1 Key matches</a> and (if specified) <a href="#key-include_globs">§ 13.2.9 Key include_globs</a>.</p>
   <h4 class="heading settled" data-level="13.2.11" id="key-world"><span class="secno">13.2.11. </span><span class="content">Key <code>world</code></span><a class="self-link" href="#key-world"></a></h4>
   <p>The <a data-link-type="dfn" href="#worlds" id="ref-for-worlds">world</a> any JavaScript scripts should be injected into. Defaults to <code>ISOLATED</code>. Valid values are defined by the <code class="idl"><a data-link-type="idl" href="#enumdef-executionworld" id="ref-for-enumdef-executionworld">ExecutionWorld</a></code> enum.</p>
   <h4 class="heading settled" data-level="13.2.12" id="runat-enum"><span class="secno">13.2.12. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="runat">RunAt</dfn> enum</span><a class="self-link" href="#runat-enum"></a></h4>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-runat"><code><c- g>RunAt</c-></code></dfn> {
    <dfn class="dfn-paneled idl-code" data-dfn-for="RunAt" data-dfn-type="enum-value" data-export id="dom-runat-document_start"><code><c- s>"document_start"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="RunAt" data-dfn-type="enum-value" data-export id="dom-runat-document_end"><code><c- s>"document_end"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="RunAt" data-dfn-type="enum-value" data-export id="dom-runat-document_idle"><code><c- s>"document_idle"</c-></code></dfn>
};
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-runat" id="ref-for-enumdef-runat①">RunAt</a></code> enum represents when a content script should be injected.</p>
   <h4 class="heading settled" data-level="13.2.13" id="executionworld-enum"><span class="secno">13.2.13. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="executionworld">ExecutionWorld</dfn> enum</span><a class="self-link" href="#executionworld-enum"></a></h4>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-executionworld"><code><c- g>ExecutionWorld</c-></code></dfn> {
    <dfn class="dfn-paneled idl-code" data-dfn-for="ExecutionWorld" data-dfn-type="enum-value" data-export id="dom-executionworld-isolated"><code><c- s>"ISOLATED"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="ExecutionWorld" data-dfn-type="enum-value" data-export id="dom-executionworld-main"><code><c- s>"MAIN"</c-></code></dfn>
};
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-executionworld" id="ref-for-enumdef-executionworld①">ExecutionWorld</a></code> enum represents a JavaScript <a data-link-type="dfn" href="#worlds" id="ref-for-worlds①">world</a>.</p>
   <h3 class="heading settled" data-level="13.3" id="extension-pages"><span class="secno">13.3. </span><span class="content">Extension pages</span><a class="self-link" href="#extension-pages"></a></h3>
   <h2 class="heading settled" data-level="14" id="classes-of-security-risk"><span class="secno">14. </span><span class="content">Classes of security risk</span><a class="self-link" href="#classes-of-security-risk"></a></h2>
   <h2 class="heading settled" data-level="15" id="web-accessible-resources"><span class="secno">15. </span><span class="content">Web accessible resources</span><a class="self-link" href="#web-accessible-resources"></a></h2>
   <h2 class="heading settled" data-level="16" id="interaction-with-the-web"><span class="secno">16. </span><span class="content">Interaction with the web</span><a class="self-link" href="#interaction-with-the-web"></a></h2>
   <h3 class="heading settled" data-level="16.1" id="current-behavior-of-cookie-partitioning"><span class="secno">16.1. </span><span class="content">Current behavior of cookie partitioning</span><a class="self-link" href="#current-behavior-of-cookie-partitioning"></a></h3>
   <h2 class="heading settled" data-level="17" id="version-number-handling"><span class="secno">17. </span><span class="content">Version number handling</span><a class="self-link" href="#version-number-handling"></a></h2>
   <h2 class="heading settled" data-level="18" id="algorithms"><span class="secno">18. </span><span class="content">Algorithms</span><a class="self-link" href="#algorithms"></a></h2>
   <h3 class="heading settled" data-level="18.1" id="determine-the-url-for-matching-a-document"><span class="secno">18.1. </span><span class="content">Determine the URL for matching a document</span><a class="self-link" href="#determine-the-url-for-matching-a-document"></a></h3>
   <p>To determine the URL to use for matching a document, given the document, <code>match_origin_as_fallback</code> and <code>match_about_blank</code>:</p>
   <ol>
    <li data-md>
     <p>Let <var>url</var> be the document’s URL.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme" id="ref-for-concept-origin-scheme">scheme</a> of <var>url</var> is <code>http</code>, <code>https</code> or <code>file</code>:</p>
     <ol>
      <li data-md>
       <p>Return <var>url</var>.</p>
     </ol>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme" id="ref-for-concept-origin-scheme①">scheme</a> of <var>url</var> is <code>blob</code>, <code>data</code> or <code>filesystem</code>, or if <var>url</var> is <code>about:blank</code> or <code>about:srcdoc</code>:</p>
     <ol>
      <li data-md>
       <p>If <code>match_origin_as_fallback</code> is set to <code>true</code>:</p>
       <ol>
        <li data-md>
         <p>If the document’s origin is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple" id="ref-for-concept-origin-tuple">tuple origin</a>:</p>
         <ol>
          <li data-md>
           <p>Let <var>document-origin</var> be the <a href="https://html.spec.whatwg.org/#ascii-serialisation-of-an-origin">serialization</a> of the document’s origin.</p>
          <li data-md>
           <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme" id="ref-for-concept-origin-scheme②">scheme</a> of <var>document-origin</var> is <code>http</code>, <code>https</code> or <code>file</code>:</p>
           <ol>
            <li data-md>
             <p>Return <var>document-origin</var>.</p>
           </ol>
          <li data-md>
           <p>Else, return null.</p>
         </ol>
        <li data-md>
         <p class="note" role="note"><span class="marker">Note:</span> If not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple" id="ref-for-concept-origin-tuple①">tuple origin</a>, the document’s origin is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>.</p>
         <ol>
          <li data-md>
           <p>Let <var>precursor-origin</var> be the <a href="https://html.spec.whatwg.org/#ascii-serialisation-of-an-origin">serialization</a> of the document’s precursor origin, if any.</p>
           <p class="issue" id="issue-efba42d5"><a class="self-link" href="#issue-efba42d5"></a> "precursor origin" concept needs to be specified. It is not in the HTML spec at the moment. At least Chrome and Firefox recognize the concept, see e.g. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1715167">https://bugzilla.mozilla.org/show_bug.cgi?id=1715167</a>.</p>
          <li data-md>
           <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme" id="ref-for-concept-origin-scheme③">scheme</a> of <var>precursor-origin</var> is <code>http</code>, <code>https</code> or <code>file</code>:</p>
           <ol>
            <li data-md>
             <p>Return <var>precursor-origin</var>.</p>
           </ol>
          <li data-md>
           <p>Else, return null.</p>
         </ol>
       </ol>
      <li data-md>
       <p>Else, if <code>match_about_blank</code> is set to <code>true</code>:</p>
       <ol>
        <li data-md>
         <p>If <var>url</var> is <code>about:blank</code> or <code>about:srcdoc</code>:</p>
         <ol>
          <li data-md>
           <p>Let <var>opener</var> be the active document of document’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context" id="ref-for-opener-browsing-context">opener browsing context</a>.</p>
          <li data-md>
           <p>If all of the following conditions are true:</p>
           <ul>
            <li data-md>
             <p><var>opener</var> is not null</p>
            <li data-md>
             <p><var>opener</var>’s origin is still the same as the document’s <u class="link-error" data-lt="opener origin at creation" title="LINK ERROR: No &apos;dfn&apos; refs found for &apos;opener origin at creation&apos; that are marked for export.
  (Possible specs this could be from: html)">opener origin at creation</u></p>
            <li data-md>
             <p>The algorithm has not been repeated for <var>opener</var> yet.</p>
           </ul>
           <p>Then repeat the algorithm for <var>opener</var>.</p>
         </ol>
       </ol>
     </ol>
    <li data-md>
     <p>Return null.</p>
   </ol>
   <h3 class="heading settled" data-level="18.2" id="inject-a-content-script"><span class="secno">18.2. </span><span class="content">Inject a content script</span><a class="self-link" href="#inject-a-content-script"></a></h3>
   <p class="issue" id="issue-9b040dd0"><a class="self-link" href="#issue-9b040dd0"></a> If the same extension specifies the same script twice, what should happen? (<a href="https://crbug.com/324096753">bug</a>)</p>
   <p>To determine if a content script should be injected in a document:</p>
   <ol>
    <li data-md>
     <p>Let <var>url</var> be the result of running <a href="#determine-the-url-for-matching-a-document">§ 18.1 Determine the URL for matching a document</a>.</p>
    <li data-md>
     <p>If the extension does not have access to <var>url</var>, return.</p>
    <li data-md>
     <p>If <var>url</var> is not matched by a match pattern in <code>matches</code>, return.</p>
    <li data-md>
     <p>If <code>include_globs</code> is present and <var>url</var> is not matched by any glob pattern, return.</p>
    <li data-md>
     <p>If <var>url</var> matches an entry in <code>exclude_matches</code> or <code>exclude_globs</code>, return.</p>
    <li data-md>
     <p>If this is a child frame, and <code>all_frames</code> is not <code>true</code>, return.</p>
    <li data-md>
     <p>Otherwise, inject the content script. This should be done based on the <code>run_at</code> setting.</p>
   </ol>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification.

    </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a>

    </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this:

    </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a>
        
    <p>This is an example of an informative example.
    </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this:

    </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#content-scripts①">Content scripts</a><span>, in § 13.2</span>
   <li><a href="#dom-runat-document_end">"document_end"</a><span>, in § 13.2.12</span>
   <li><a href="#dom-runat-document_idle">"document_idle"</a><span>, in § 13.2.12</span>
   <li><a href="#dom-runat-document_start">"document_start"</a><span>, in § 13.2.12</span>
   <li>
    ExecutionWorld
    <ul>
     <li><a href="#enumdef-executionworld">(enum)</a><span>, in § 13.2.13</span>
     <li><a href="#executionworld">definition of</a><span>, in § 13.2.13</span>
    </ul>
   <li><a href="#glob">glob</a><span>, in § 10</span>
   <li><a href="#dom-executionworld-isolated">"ISOLATED"</a><span>, in § 13.2.13</span>
   <li><a href="#dom-executionworld-main">"MAIN"</a><span>, in § 13.2.13</span>
   <li><a href="#manifest①">manifest</a><span>, in § 2</span>
   <li><a href="#match-pattern">match pattern</a><span>, in § 9</span>
   <li>
    RunAt
    <ul>
     <li><a href="#enumdef-runat">(enum)</a><span>, in § 13.2.12</span>
     <li><a href="#runat">definition of</a><span>, in § 13.2.12</span>
    </ul>
   <li><a href="#worlds">Worlds</a><span>, in § 3</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[ECMASCRIPT]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="00bda90a">list</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b01b1359">opaque origin</span>
     <li><span class="dfn-paneled" id="78787bc5">opener browsing context</span>
     <li><span class="dfn-paneled" id="a23d12a9">scheme</span>
     <li><span class="dfn-paneled" id="1d2aa117">tuple origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="0698d556">string</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-ecmascript">[ECMASCRIPT]
   <dd><a href="https://tc39.es/ecma262/multipage/"><cite>ECMAScript Language Specification</cite></a>. URL: <a href="https://tc39.es/ecma262/multipage/">https://tc39.es/ecma262/multipage/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-json">[JSON]
   <dd>T. Bray, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc8259"><cite>The JavaScript Object Notation (JSON) Data Interchange Format</cite></a>. December 2017. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8259">https://www.rfc-editor.org/rfc/rfc8259</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>enum</c-> <a href="#enumdef-runat"><code><c- g>RunAt</c-></code></a> {
    <a href="#dom-runat-document_start"><code><c- s>"document_start"</c-></code></a>,
    <a href="#dom-runat-document_end"><code><c- s>"document_end"</c-></code></a>,
    <a href="#dom-runat-document_idle"><code><c- s>"document_idle"</c-></code></a>
};

<c- b>enum</c-> <a href="#enumdef-executionworld"><code><c- g>ExecutionWorld</c-></code></a> {
    <a href="#dom-executionworld-isolated"><code><c- s>"ISOLATED"</c-></code></a>,
    <a href="#dom-executionworld-main"><code><c- s>"MAIN"</c-></code></a>
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Specify localization handling. <a href="https://github.com/w3c/webextensions/issues/62">[Issue #62]</a> <a class="issue-return" href="#issue-e5b8cfc7" title="Jump to section">↵</a></div>
   <div class="issue"> "precursor origin" concept needs to be specified. It is not in the HTML spec at the moment. At least Chrome and Firefox recognize the concept, see e.g. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1715167">https://bugzilla.mozilla.org/show_bug.cgi?id=1715167</a>. <a class="issue-return" href="#issue-efba42d5" title="Jump to section">↵</a></div>
   <div class="issue"> If the same extension specifies the same script twice, what should happen? (<a href="https://crbug.com/324096753">bug</a>) <a class="issue-return" href="#issue-9b040dd0" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"00bda90a": {"dfnID":"00bda90a","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-list-and-record-specification-type"}],"title":"2.2.11. Key content_scripts"},{"refs":[{"id":"ref-for-sec-list-and-record-specification-type\u2460"}],"title":"13.2.1. Key matches"},{"refs":[{"id":"ref-for-sec-list-and-record-specification-type\u2461"}],"title":"13.2.2. Key exclude_matches"},{"refs":[{"id":"ref-for-sec-list-and-record-specification-type\u2462"}],"title":"13.2.3. Key js"},{"refs":[{"id":"ref-for-sec-list-and-record-specification-type\u2463"}],"title":"13.2.4. Key css"},{"refs":[{"id":"ref-for-sec-list-and-record-specification-type\u2464"}],"title":"13.2.10. Key exclude_globs"}],"url":"https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type"},
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"}],"title":"10. Globs"}],"url":"https://infra.spec.whatwg.org/#string"},
"1d2aa117": {"dfnID":"1d2aa117","dfnText":"tuple origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-tuple"},{"id":"ref-for-concept-origin-tuple\u2460"}],"title":"18.1. Determine the URL for matching a document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple"},
"78787bc5": {"dfnID":"78787bc5","dfnText":"opener browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-opener-browsing-context"}],"title":"18.1. Determine the URL for matching a document"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context"},
"a23d12a9": {"dfnID":"a23d12a9","dfnText":"scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-scheme"},{"id":"ref-for-concept-origin-scheme\u2460"},{"id":"ref-for-concept-origin-scheme\u2461"},{"id":"ref-for-concept-origin-scheme\u2462"}],"title":"18.1. Determine the URL for matching a document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme"},
"b01b1359": {"dfnID":"b01b1359","dfnText":"opaque origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-opaque"}],"title":"18.1. Determine the URL for matching a document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"content-scripts①": {"dfnID":"content-scripts\u2460","dfnText":"Content scripts","external":false,"refSections":[{"refs":[{"id":"ref-for-content-scripts\u2460"}],"title":"2.2.11. Key content_scripts"}],"url":"#content-scripts\u2460"},
"dom-executionworld-isolated": {"dfnID":"dom-executionworld-isolated","dfnText":"\"ISOLATED\"","external":false,"refSections":[],"url":"#dom-executionworld-isolated"},
"dom-executionworld-main": {"dfnID":"dom-executionworld-main","dfnText":"\"MAIN\"","external":false,"refSections":[],"url":"#dom-executionworld-main"},
"dom-runat-document_end": {"dfnID":"dom-runat-document_end","dfnText":"\"document_end\"","external":false,"refSections":[],"url":"#dom-runat-document_end"},
"dom-runat-document_idle": {"dfnID":"dom-runat-document_idle","dfnText":"\"document_idle\"","external":false,"refSections":[],"url":"#dom-runat-document_idle"},
"dom-runat-document_start": {"dfnID":"dom-runat-document_start","dfnText":"\"document_start\"","external":false,"refSections":[],"url":"#dom-runat-document_start"},
"enumdef-executionworld": {"dfnID":"enumdef-executionworld","dfnText":"ExecutionWorld","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-executionworld"}],"title":"13.2.11. Key world"},{"refs":[{"id":"ref-for-enumdef-executionworld\u2460"}],"title":"13.2.13. ExecutionWorld enum"}],"url":"#enumdef-executionworld"},
"enumdef-runat": {"dfnID":"enumdef-runat","dfnText":"RunAt","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-runat"}],"title":"13.2.8. Key run_at"},{"refs":[{"id":"ref-for-enumdef-runat\u2460"}],"title":"13.2.12. RunAt enum"}],"url":"#enumdef-runat"},
"executionworld": {"dfnID":"executionworld","dfnText":"ExecutionWorld","external":false,"refSections":[],"url":"#executionworld"},
"glob": {"dfnID":"glob","dfnText":"glob","external":false,"refSections":[{"refs":[{"id":"ref-for-glob"}],"title":"13.2.9. Key include_globs"},{"refs":[{"id":"ref-for-glob\u2460"}],"title":"13.2.10. Key exclude_globs"}],"url":"#glob"},
"manifest①": {"dfnID":"manifest\u2460","dfnText":"manifest","external":false,"refSections":[{"refs":[{"id":"ref-for-manifest\u2460"}],"title":"1.3. Other files"}],"url":"#manifest\u2460"},
"match-pattern": {"dfnID":"match-pattern","dfnText":"match pattern","external":false,"refSections":[{"refs":[{"id":"ref-for-match-pattern"}],"title":"13.2.1. Key matches"},{"refs":[{"id":"ref-for-match-pattern\u2460"}],"title":"13.2.2. Key exclude_matches"}],"url":"#match-pattern"},
"runat": {"dfnID":"runat","dfnText":"RunAt","external":false,"refSections":[],"url":"#runat"},
"worlds": {"dfnID":"worlds","dfnText":"Worlds","external":false,"refSections":[{"refs":[{"id":"ref-for-worlds"}],"title":"13.2.11. Key world"},{"refs":[{"id":"ref-for-worlds\u2460"}],"title":"13.2.13. ExecutionWorld enum"}],"url":"#worlds"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#content-scripts①": {"displayText":"content scripts","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"content scripts","type":"dfn","url":"#content-scripts\u2460"},
"#enumdef-executionworld": {"displayText":"ExecutionWorld","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"ExecutionWorld","type":"enum","url":"#enumdef-executionworld"},
"#enumdef-runat": {"displayText":"RunAt","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"RunAt","type":"enum","url":"#enumdef-runat"},
"#glob": {"displayText":"glob","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"glob","type":"dfn","url":"#glob"},
"#manifest①": {"displayText":"manifest","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"manifest","type":"dfn","url":"#manifest\u2460"},
"#match-pattern": {"displayText":"match pattern","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"match pattern","type":"dfn","url":"#match-pattern"},
"#worlds": {"displayText":"worlds","export":true,"for_":[],"level":"1","normative":true,"shortname":"webextensions","spec":"webextensions-1","status":"local","text":"worlds","type":"dfn","url":"#worlds"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque": {"displayText":"opaque origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opaque origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme": {"displayText":"scheme","export":true,"for_":["origin"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"scheme","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple": {"displayText":"tuple origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"tuple origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context": {"displayText":"opener browsing context","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opener browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context"},
"https://infra.spec.whatwg.org/#string": {"displayText":"string","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type": {"displayText":"list","export":true,"for_":["ECMAScript"],"level":"1","normative":true,"shortname":"ecmascript","spec":"ecmascript","status":"current","text":"list","type":"dfn","url":"https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-list-and-record-specification-type"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>